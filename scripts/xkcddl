import urllib
import sys, re
import os.path

recent_location_re = re.compile ('Permanent link to this comic: http://xkcd.com/([^<]*)/')
jpg_location_re = re.compile ('\(for hotlinking/embedding\): ([^<]*)</h3>')

def opt ():
    print'#     Welcome to XKMD'
    print'# The XKCD Mass Downloader'
    print'#'
    print'# -m Mass Downloader (In order for -u to work you must run this first)'
    print'# -u Update Your XKCD Collection'
    print'# -g Grab a Specific Comic'
    print'# -o Brings up Options List'
    print'# -q Quit XKMD'
    print'#'
    print''
    
    cmd = raw_input('xkmd: ')

    while 1:
        if cmd == '-q':
            break
        elif cmd == '-o':
            opt()
        elif cmd == '-m':
            mass()
            cmd = raw_input('xkmd: ')
        elif cmd == '-u':
            update()
            cmd = raw_input('xkmd: ')
        elif cmd == '-g':
            grab()
            cmd = raw_input('xkmd: ')
        else:
            print'Invalid Command'
            cmd = raw_input('xkmd: ')
    

#Downloads Every XKCD in existance
def mass ():
        print'XKMD Mass Downloader Function'
        comfirm = raw_input('Would you like to populate your /xkcd/ folder (y/n): ')
        if comfirm == 'y':
            xkcdNum = 0
            downloadControl(xkcdNum)
            print 'Your /xkcd/ Folder Has Been Filled with every XKCD Comic'
        
def update ():
    print'XKMD Update Function'
    comfirm = raw_input('Would you like to update your collection (y/n): ')
    if comfirm == 'y':
        cDir = os.getcwd()
        updFile = open(cDir + '/update', 'r')
        lastDown = updFile.read()
        updFile.close()
        downloadControl(int(lastDown))
        print 'Your /xkcd/ Folder Has Been Updated'

def grab ():
    print'XKMD Grab Function'
    xkcdNum = input('Enter XKCD comic number to download: ')
    download(xkcdNum)
    print 'Comic ' + str(xkcdNum) + ' Has Been Downloaded'

def downloadControl (self):
        xkcdMax = urllib.urlopen('http://www.xkcd.com')
        xkcdMaxNum = xkcdMax.read()
        xkcdMax.close()
        recent = recent_location_re.search(xkcdMaxNum)
        maxNum = int(recent.group(1))
        cDir = os.getcwd()
        updFile = open(cDir + '/update', 'w')
        updFile.write(str(maxNum))
        updFile.close()
        print 'Update File Updated ;)'
        while self < maxNum:
            self = self + 1
            download (self)
            

def download (self):
            if self == 404:
                self = 405
            xkcdStr = str(self)
            xkcdUrl = 'http://www.xkcd.com/' + xkcdStr + '/'
            print xkcdUrl
            url = urllib.urlopen(xkcdUrl)
            urlC = url.read()
            url.close()
            jpg = jpg_location_re.search(urlC)
            print jpg.group(1)
            exten = os.path.splitext(jpg.group(1))[1]
            title = 'XKCD' + xkcdStr + exten
            cDir = os.getcwd()
            DLLoc = cDir + '/xkcd/' + title
            urllib.urlretrieve(jpg.group(1), DLLoc)
            urllib.urlcleanup()

opt()
